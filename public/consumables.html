<!DOCTYPE html>
<html lang="en" class="app">
<head>
<meta charset="utf-8" />
<title>肠道微生态全菌群自动化提取设备管理系统</title>
<meta name="description" content="app, web app, responsive, admin dashboard, admin, flat, flat ui, ui kit, off screen nav" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<link rel="shortcut icon" href="images/logo.png">
<link rel="stylesheet" href="css/app.v2.css" type="text/css" />
<link rel="stylesheet" href="js\calendar/bootstrap_calendar.css" type="text/css" cache="false" />
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="css/bootstrap-table.css">
<script src="js/jquery-2.1.0.js" cache="false"></script>
<style>
  .import{
    width: 500px;
    top: 0;
    left: 100%;
    padding: 0;
    margin: 0 0 0 5px;
    box-shadow: none;
    border: none;
    line-height: auto;
    background-color: transparent;
    display: none;
  }
  .addConsumable{
    width: 500px;
    min-height: 350px;
    position: absolute;
    top: 50%;
    left: 50%;
    margin: -200px 0 0 -250px;
  }
  .markConsumable{
    width: 500px;
    min-height: 250px;
    position: absolute;
    top: 50%;
    left: 50%;
    margin: -150px 0 0 -250px;
  }
</style>
</head>
<body>
<section class="vbox">
  <!-- 头部 -->
  <header class="bg-dark dk header navbar navbar-fixed-top-xs">
    <div class="navbar-header aside-md" style="width:600px;">
      <a href="#" class="navbar-brand" data-toggle="fullscreen">
        <img class="logo" src="images/logo.png" class="m-r-sm">
        肠道微生态全菌群自动化提取设备管理系统
      </a>
    </div>    
    <ul class="nav navbar-nav navbar-right hidden-xs nav-user">
      <li class="hidden-xs">
        <a href="#" class="dropdown-toggle dk" data-toggle="dropdown">
          <i class="fa fa-bell"></i>
          <span id="alarmNum" class="badge badge-sm up bg-danger m-l-n-sm">0</span>
        </a>
        <!-- 报警下拉 -->
        <ul class="dropdown-menu animated fadeInRight" id="alarm-header-list"></ul>
      </li>      
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
          <span id="userName"></span>
          <b class="caret"></b>
        </a>
        <!-- 用户操作 -->
        <ul class="dropdown-menu animated fadeInRight">
          <li><a href="#" onclick="changeUserInfo()">修改个人信息</a></li>
          <li><a href="#" onclick="changePassword()">修改密码</a></li>
          <li class="divider"></li>
          <li><a href="#" onclick="logout()">退出登录</a></li>
        </ul>
      </li>
    </ul>
  </header>
  <section>
    <section class="hbox stretch">
      <aside class="bg-dark lter aside-md hidden-print" id="nav">
        <section class="vbox">
          <section class="w-f scrollable">
              <div class="slim-scroll" data-height="auto" data-disable-fade-out="true" data-distance="0" data-size="5px" data-color="#333333"> <!-- 导航 -->
              <nav class="nav-primary hidden-xs">
                <ul class="nav">
                  <li><a href="home.html"><i class="fa fa-dashboard icon"><b class="bg-danger"></b></i><span>首页</span></a></li>
                  <li><a href="#equipment"><i class="fa fa-bell icon"><b class="bg-primary"></b></i><span class="pull-right"><i class="fa fa-angle-down text"></i><i class="fa fa-angle-up text-active"></i></span><span>设备</span></a>
                    <ul class="nav lt">
                      <li><a href="project.html"><i class="fa fa-angle-right"></i><span>用户</span></a></li>
                      <li><a href="equipment.html"><i class="fa fa-angle-right"></i><span>设备</span></a></li>
                    </ul>
                  </li>
                  <li class="active"><a href="consumables.html"><i class="fa fa-flask icon"><b class="bg-success"></b></i><span>耗材</span></a></li>
                  <li><a href="#alarm"><i class="fa fa-bell icon"><b class="bg-primary"></b></i><span class="pull-right"><i class="fa fa-angle-down text"></i><i class="fa fa-angle-up text-active"></i></span><span>报警</span></a>
                    <ul class="nav lt">
                      <li><a href="current_alarm.html"><i class="fa fa-angle-right"></i><span>当前报警</span></a></li>
                      <li><a href="historical_alarm.html"><i class="fa fa-angle-right"></i><span>历史报警</span></a></li>
                    </ul>
                  </li>
                  <li><a href="#statistics"><i class="fa fa-list-ol"><b class="bg-primary dker"></b></i><span class="pull-right"><i class="fa fa-angle-down text"></i><i class="fa fa-angle-up text-active"></i></span><span>统计</span></a>
                    <ul class="nav lt">
                      <li><a href="run_time_statistics.html"><i class="fa fa-angle-right"></i><span>运行时长</span></a></li>
                      <li><a href="equipment_statistics.html"><i class="fa fa-angle-right"></i><span>设备统计</span></a></li>
                      <li><a href="consumable_statistics.html"><i class="fa fa-angle-right"></i><span>耗材统计</span></a></li>
                    </ul>
                  </li>
                  <li><a href="#system"><i class="fa fa-windows"><b class="bg-info"></b></i><span class="pull-right"><i class="fa fa-angle-down text"></i><i class="fa fa-angle-up text-active"></i></span><span>系统</span></a>
                    <ul class="nav lt">
                      <li><a href="user.html"><i class="fa fa-angle-right"></i><span>用户</span></a></li>
                      <li><a href="role.html"><i class="fa fa-angle-right"></i><span>角色</span></a></li>
                      <li><a href="privileges.html"><i class="fa fa-angle-right"></i><span>权限</span></a></li>                  
                    </ul>
                  </li>                  
                </ul>
              </nav>
            </div>
          </section>
          <footer class="footer lt hidden-xs b-t b-dark">            
            <a href="#nav" data-toggle="class:nav-xs" class="pull-right btn btn-sm btn-dark btn-icon"><i class="fa fa-angle-left text"></i><i class="fa fa-angle-right text-active"></i></a>
          </footer>
        </section>
      </aside>
      <!-- 内容 -->
      <section id="content">
        <section class="vbox">
          <div class="opGroup">
            <button class="btn btn-default" onclick="addConsumable()">添加</button>
            <button class="btn btn-default" onclick="changeConsumable()">修改</button>
            <button class="btn btn-default" onclick="deleteConsumable()">删除</button>
            <button class="btn btn-default" onclick="markConsumable()">标记</button>
            <button class="btn btn-default" id="import" >导入</button>
            <span class="animated fadeInLeft import">
              <input type="file" id="file" name="filename" class="filestyle" data-icon="false" data-classButton="btn btn-default" data-classInput="form-control inline input-s"/>
              <button type="button" class="btn btn-default" onclick="improtConsumable()">开始导入</button>
            </span>
          </div>
          <div class="indexTable">
            <table id="indexTable" width="100%"></table>
          </div>
        </section>
        </section>
    </section>
  </section>
</section>
<div class="mask"></div>
<script src="js/app.v2.js"></script>
<script src="js/bootstrap-table.js"></script>
<script src="js/bootstrap-table-zh-CN.min.js"></script>
<script src="js/tableExport.min.js"></script>
<script src="js/bootstrap-table-export.min.js"></script>
<script src="js/file-input/bootstrap-filestyle.min.js"></script>
<script src="js/date/WdatePicker.js"></script>
<script src="js/layer/layer.js"></script>
<script src="js/reqDomain.js"></script>
<script src="js/md5.js"></script>
<script src="js/common.js"></script>
<script>
  $(function(){
    getConsumableList()
    alarm()
  })
  var show = false;
  var tableRow = null;
  $('#import').click(function(){
    if(show){
      $(this).next().hide()
    }else{
      $(this).next().show()
    }
    show = !show
  })
  $('#indexTable').bootstrapTable({
    clickToSelect: true,
    height: document.getElementsByTagName('body')[0].scrollHeight-100,
    showColumns: true,
    showExport: true,
    search: true,
    exportDataType: 'all',
    searchTimeOut: 700,
    toolbar: '.opGroup',
    columns: [
      {
        title: '序号',
        formatter: function(value,row,index){
          return index + 1
        }
      },{
        title: '耗材名称',
        field: 'name'
      },{
        title: '耗材id',
        field: 'rfid',
      },{
        title: '耗材类型',
        field: 'category',
        formatter: function(value){
          if(value == 1){
            return '默认类型'
          }else{
            return value
          }
        }
      },{
        title: '用户',
        field: 'customer'
      },{
        title: '批次',
        field: 'batch'
      },{
        title: '状态',
        field: 'status',
        formatter: function(value){
          return value == 0 ? '正常' : '异常'
        }
      },{
        title: '销售时间',
        field: 'sale_time'
      },{
        title: '备注',
        field: 'remark'
      }
    ],
    onPostBody:function(){
      var header = $(".fixed-table-header table thead tr th");
      var body = $(".fixed-table-header table tbody tr td");
      var footer = $(".fixed-table-header table tr td");
        body.each(function(){
        header.width((this).width());
        footer.width((this).width());
      });
    }
  })
  $('#indexTable').on('click-row.bs.table',function(e,row,element){
    $(element).addClass('bg').siblings().removeClass('bg');
    tableRow = row;
  })
  
  // 耗材列表
  function getConsumableList(){
    $.ajax({
      type: "post",
      url: reqDomain + "/index/consumable/consumable_list",
      dataType: "json",
      success: function (data) {
        if(data.code == 200){
          $('#indexTable').bootstrapTable('load', data.result)
        }
      }
    });
  }
  // 添加耗材
  function addConsumable(){
    (function(){
      var str = '<div class="addConsumable">'+
                '<div class="popover-title">添加耗材'+
                  '<button type="button" class="close pullright">&times;</button>'+
                '</div>'+
                '<div class="popover-content">'+
                  '<table>'+                  
                    '<tr>'+
                      '<td>耗材名称：</td>'+
                      '<td><input type="text" id="name" class="form-control"></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>耗材id：</td>'+
                      '<td><input class="form-control" id="rfid" /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>设备类型：</td>'+
                      '<td><select class="form-control" id="category"><option value="1">默认类型</option></select></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>用户：</td>'+
                      '<td><input class="form-control" id="customer" /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>批次：</td>'+
                      '<td><input class="form-control" id="batch" /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>销售时间：</td>'+
                      '<td><input class="form-control" id="sale_time" class="form-control" onfocus="WdatePicker({ dateFmt:\'yyyy-MM-dd\'})" placeholder="请选择开始时间" autocomplete="off" /></td>'+
                    '</tr>'+
                  '</table>'+
                  '<button class="btn btn-default save">保存</button>'+
                '</div>'+
              '</div>';
      $('.mask').show().html(str);
    })()
    // 添加保存
    $('.save').click(function(){
      if($('#name').val() == ''){
        layer.mag('耗材名称不能为空')
      }else if($('#rfid').val() == ''){
        layer.msg('耗材id不能为空')
      }else{
        $.ajax({
          type: "post",
          url: reqDomain + "/index/consumable/consumable_save",
          data: {
            category: $('#category').val(),
            name: $('#name').val(),
            rfid: $('#rfid').val(),
            customer: $('#customer').val(),
            sale_time: $('#sale_time').val(),
            batch: $('#batch').val()
          },
          dataType: "json",
          success: function (data) {
            if(data.code == 200){
              layer.msg('添加成功');
              $('.mask').empty().hide()
              getConsumableList()
            }
          }
        });
      }
    })
    // 关闭弹框
    $('.close').click(function(){
      $('.mask').empty().hide()
    })
  }
  // 导入耗材
  function improtConsumable(){
    var file = document.getElementById('file').files;
    var formData = new FormData()
    formData.append('excel',file[0])
    console.log(formData.get('file'))
    $.ajax({
      cache: false,
      type: "post",
      url: reqDomain + "/index/consumable/consumable_import",
      data: formData,
      dataType: 'formData',
      processData: false,
      contentType: false,
      beforeSend: function() {
        layer.msg('数据上传中...', {icon: 16,shade: [0.3,'#fff']});
      },
      success: function (data) {
        if(data.code == 200){
          layer.closeAll();
          layer.msg('耗材导入成功');
          getConsumableList()
        }
      }
    });
  }
  // 修改耗材
  function changeConsumable(){
    if(tableRow == null){
      layer.msg('请选择一个耗材');
      return false
    }
    (function(){
      var str = '<div class="addConsumable">'+
                '<div class="popover-title">修改耗材'+
                  '<button type="button" class="close pullright">&times;</button>'+
                '</div>'+
                '<div class="popover-content">'+
                  '<table>'+                  
                    '<tr>'+
                      '<td>耗材名称：</td>'+
                      '<td><input type="text" id="name" class="form-control"></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>耗材id：</td>'+
                      '<td><input class="form-control" id="rfid" /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>设备类型：</td>'+
                      '<td><select class="form-control" id="category"><option value="1">默认类型</option></select></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>用户：</td>'+
                      '<td><input class="form-control" id="customer" /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>批次：</td>'+
                      '<td><input class="form-control" id="batch" /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td> 销售时间：</td>'+
                      '<td><input class="form-control" id="sale_time" class="form-control" onfocus="WdatePicker({ dateFmt:\'yyyy-MM-dd\'})" placeholder="请选择开始时间" autocomplete="off" /></td>'+
                    '</tr>'+
                  '</table>'+
                  '<button class="btn btn-default save">保存</button>'+
                '</div>'+
              '</div>';
      $('.mask').show().html(str);
      $('#category').val(tableRow.category)
      $('#name').val(tableRow.name)
      $('#rfid').val(tableRow.rfid)
      $('#customer').val(tableRow.customer)
      $('#sale_time').val(tableRow.sale_time)
      $('#batch').val(tableRow.batch)
    })()
    // 添加保存
    $('.save').click(function(){
      if($('#name').val() == ''){
        layer.mag('耗材名称不能为空')
      }else if($('#rfid').val() == ''){
        layer.msg('耗材id不能为空')
      }else{
        $.ajax({
          type: "post",
          url: reqDomain + "/index/consumable/consumable_save",
          data: {
            id: tableRow.id,
            category: $('#category').val(),
            name: $('#name').val(),
            rfid: $('#rfid').val(),
            customer: $('#customer').val(),
            sale_time: $('#sale_time').val(),
            batch: $('#batch').val()
          },
          dataType: "json",
          success: function (data) {
            if(data.code == 200){
              layer.msg('修改成功');
              $('.mask').empty().hide()
              tableRow = null;
              getConsumableList()
            }
          }
        });
      }
    })
    // 关闭弹框
    $('.close').click(function(){
      $('.mask').empty().hide()
    })
  }
  // 删除耗材
  function deleteConsumable(){
    if(tableRow == null){
      layer.msg('请选择一个耗材');
      return false
    }
    layer.confirm('确定要删除该耗材么？',function(){
      $.ajax({
        type: "post",
        url: reqDomain + "/index/consumable/consumable_delete",
        data: {
          id: tableRow.id
        },
        dataType: "json",
        success: function (data) {
          if(data.code == 200){
            layer.msg('删除成功');
            tableRow = null;
            getConsumableList()
          }
        }
      });
    })
  }
  // 标记耗材
  function markConsumable(){
    if(tableRow == null){
      layer.msg('请选择一个耗材');
      return false
    }
    (function(){
      var str = '<div class="markConsumable">'+
                '<div class="popover-title">标记耗材'+
                  '<button type="button" class="close pullright">&times;</button>'+
                '</div>'+
                '<div class="popover-content">'+
                  '<table>'+                  
                    '<tr>'+
                      '<td>耗材名称：</td>'+
                      '<td><input type="text" id="name" disabled class="form-control"></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>耗材id：</td>'+
                      '<td><input class="form-control" id="rfid" disabled /></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>耗材状态：</td>'+
                      '<td><select class="form-control" id="status"><option value="0">正常</option><option value="1">异常</option></select></td>'+
                    '</tr>'+
                    '<tr>'+
                      '<td>备注：</td>'+
                      '<td><input class="form-control" id="remark" /></td>'+
                    '</tr>'+                    
                  '</table>'+
                  '<button class="btn btn-default save">保存</button>'+
                '</div>'+
              '</div>';
      $('.mask').show().html(str)
      console.log(tableRow)
      $('#rfid').val(tableRow.rfid)
      $('#name').val(tableRow.name)
      $('#status').val(tableRow.status)
      $('#remark').val(tableRow.remark)
    })()
    // 添加保存
    $('.save').click(function(){      
      $.ajax({
        type: "post",
        url: reqDomain + "/index/consumable/consumable_mark",
        data: {
          id: tableRow.id,
          status: $('#status').val(),
          remark: $('#remark').val(),
        },
        dataType: "json",
        success: function (data) {
          if(data.code == 200){
            layer.msg('标记成功');
            $('.mask').empty().hide()
            tableRow = null;
            getConsumableList()
          }
        }
      });      
    })
    // 关闭弹框
    $('.close').click(function(){
      $('.mask').empty().hide()
    })
  }
</script>
</body>
</html>